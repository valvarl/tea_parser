
import asyncio
import datetime
import json
import sys
sys.path.insert(0, "/home/valvarl/tea_parser/backend")

from app.services.indexer import ProductIndexer
from app.services.enricher import ProductEnricher

# idx = ProductIndexer()
# base_rows = asyncio.run(idx.search_products("пуэр", headless=False))

base_rows = [{'sku': '2029715814', 'link': '/product/smola-puera-cha-gao-assorti-5-vkusov-v-podarochnoy-korobke-50-sht-2029715814/', 'name': 'Смола пуэра Ча Гао ассорти 5 вкусов в подарочной коробке 50 шт', 'price_curr': 594, 'price_old': 1325, 'rating': 4.8, 'reviews': 3240, 'images': 'https://cdn1.ozone.ru/s3/multimedia-1-4/7599847504.jpg|https://cdn1.ozone.ru/s3/multimedia-1-7/7599847507.jpg|https://cdn1.ozone.ru/s3/multimedia-1-j/7599847483.jpg|https://cdn1.ozone.ru/s3/multimedia-1-4/7478195656.jpg|https://cdn1.ozone.ru/s3/multimedia-1-q/7417964366.jpg|https://cdn1.ozone.ru/s3/multimedia-1-t/7478195681.jpg', 'delivery_day_raw': 'Послезавтра', 'delivery_date': datetime.date(2025, 8, 7), 'max_qty': 338, 'first_seen': datetime.datetime(2025, 8, 5, 10, 5, 17, 953675)},]

enricher = ProductEnricher(reviews=True, reviews_limit=50, states=True, state_ids=["webGallery", "webPrice"], state_regex=False)
rows_plus, reviews = asyncio.run(enricher.enrich(base_rows))

# print(rows_plus)

# print(reviews)

# rows_plus = [{'sku': '2029715814', 'link': '/product/smola-puera-cha-gao-assorti-5-vkusov-v-podarochnoy-korobke-50-sht-2029715814/', 'name': 'Смола пуэра Ча Гао ассорти 5 вкусов в подарочной коробке 50 шт', 'price_curr': 594, 'price_old': 1325, 'rating': 4.8, 'reviews': 3240, 'images': 'https://cdn1.ozone.ru/s3/multimedia-1-4/7599847504.jpg|https://cdn1.ozone.ru/s3/multimedia-1-7/7599847507.jpg|https://cdn1.ozone.ru/s3/multimedia-1-j/7599847483.jpg|https://cdn1.ozone.ru/s3/multimedia-1-4/7478195656.jpg|https://cdn1.ozone.ru/s3/multimedia-1-q/7417964366.jpg|https://cdn1.ozone.ru/s3/multimedia-1-t/7478195681.jpg', 'delivery_day_raw': 'Послезавтра', 'delivery_date': datetime.date(2025, 8, 7), 'max_qty': 338, 'first_seen': datetime.datetime(2025, 8, 5, 10, 5, 17, 953675), 'charcs_json': '{"totalCount":16, "link":"https://www.ozon.ru/product/smola-puera-cha-gao-assorti-5-vkusov-v-podarochnoy-korobke-50-sht-2029715814/features/", "characteristics":[{"short":[{"key":"Sku", "name":"Артикул", "values":[{"text":"2029715814", "key":"Sku"}], "copyText":"2029715814"}, {"key":"Type", "name":"Тип", "values":[{"text":"Чай растворимый", "link":"/category/chay-rastvorimyy-i-granulirovannyy-v-piramidkah/", "key":"Type_0"}]}, {"key":"TeaType", "name":"Вид чая", "values":[{"text":"Пуэр", "link":"/category/chay-rastvorimyy-puer/", "key":"TeaType_0"}, {"text":"Зеленый", "link":"/category/chay-rastvorimyy-i-granulirovannyy-zelenyy/", "key":"TeaType_1"}, {"text":"Черный", "link":"/category/chay-rastvorimyy-i-granulirovannyy-chernyy/", "key":"TeaType_2"}]}, {"key":"TeaGrade", "name":"Сорт чая", "values":[{"text":"Шу Пуэр", "link":"/category/rastvorimyy-chay-shu-puer/", "key":"TeaGrade_0"}, {"text":"Шэн Пуэр", "key":"TeaGrade_1"}]}, {"key":"VarietyTeaShape", "name":"Форма чая", "values":[{"text":"Концентрат", "key":"VarietyTeaShape_0"}]}, {"key":"EffectTea", "name":"Свойства чая", "values":[{"text":"Бодрящий", "link":"/category/chay-rastvorimyy-s-bodryashchim-effektom/", "key":"EffectTea_0"}, {"text":"Очищающий", "link":"/category/ochishchayushchiy-rastvorimyy-chay/", "key":"EffectTea_1"}, {"text":"Укрепляющий", "link":"/category/chay-granulirovannyy-s-ukreplyayushchim-effektom/", "key":"EffectTea_2"}]}, {"key":"Manufacturing", "name":"Технология производства", "values":[{"text":"Сублимированный", "key":"Manufacturing_0"}]}, {"key":"QuantityUOM", "name":"Единиц в одном товаре", "values":[{"text":"50", "key":"QuantityUOM_0"}]}, {"key":"Weight", "name":"Вес товара, г", "values":[{"text":"30", "key":"Weight_0"}]}, {"key":"ServiceMinTemperature", "name":"Минимальная температура", "values":[{"text":"5", "key":"ServiceMinTemperature_0"}]}, {"key":"ServiceMaxTemperature", "name":"Максимальная температура", "values":[{"text":"25", "key":"ServiceMaxTemperature_0"}]}, {"key":"NotContain", "name":"Не содержит", "values":[{"text":"без ГМО", "key":"NotContain_0"}, {"text":"без ароматизаторов", "key":"NotContain_1"}, {"text":"без глютена", "key":"NotContain_2"}, {"text":"без злаков", "key":"NotContain_3"}]}, {"key":"NewFeatures", "name":"Особенности напитков, продуктов питания", "values":[{"text":"Натуральный продукт", "link":"/category/chay-rastvorimyy-naturalnyy/", "key":"NewFeatures_0"}]}, {"key":"ShelfLife", "name":"Срок годности в днях", "values":[{"text":"1095", "key":"ShelfLife_0"}]}, {"key":"Country", "name":"Страна-изготовитель", "values":[{"text":"Китай", "key":"Country_0"}, {"text":"Россия", "link":"/category/chay-granulirovannyy-proizvodstva-rossii/", "key":"Country_1"}]}, {"key":"Packing", "name":"Упаковка", "values":[{"text":"Подарочная коробка", "key":"Packing_0"}, {"text":"Картонная коробка", "link":"/category/chay-rastvorimyy-v-kartonnoy-korobke/", "key":"Packing_1"}]}, {"key":"Nametaste", "name":"Название вкуса", "values":[{"text":"Ассорти 5 вкусов", "key":"Nametaste_0"}]}]}], "productTitle":"Характеристики: Смола пуэра Ча Гао ассорти 5 вкусов в подарочной коробке 50 шт", "lexemes":{"allCharacteristicsText":"Все характеристики", "ariaLabel":"Подсказка", "collapseText":"Свернуть", "moreText":"Подробнее", "notificationError":"Ваш браузер не поддерживает данный функционал", "shawAllCharacteristicsText":"Показать все характеристики", "successfulCopyText":"Артикул скопирован"}, "cellTrackingInfo":{"uis":{"main":"XQtkV4mOZFg4qxDQCyOQ2W9flG1AWECMXrON0fJ21m6", "sku":"16tL268qXfOGYR0BuLKVD6Vhj7jwjNfnlxNGnhLR856G", "suggest":"A6tGLZjE5cno4wQqh3LWJxLIjg0RPpioRP2gYh5m99AO"}, "tags":{"Country_1":"OgtEzN3vkFvMGZ8ki1k9lLJuoZkVv1tw3pknofAoAX7", "EffectTea_0":"LZtlykLQ2TNvX0N7CmLK5mFgvJzxCXrzoNXTv1yVy5", "EffectTea_1":"OgtEzN3vkFlo6Qw4ImAQ8KWC10gG55h6rz7ZVfAA4E29", "EffectTea_2":"46tRMzrlxTPkz4XXFMz8jBMcJZ3WXgs6AOPQQtqPO1Ky", "NewFeatures_0":"GRt2KBwA9F0R0vxgTmj7A7mtNYNjqQSO87xjWt5xRE6y", "Packing_1":"pZtp195AZikjKRL4U126ZzMS5R3ZLyc0pDoymfpPDv4p", "TeaGrade_0":"lRt601LXlC90N3LACkvwONtAY3ORDfRO38zMtADAjzr", "TeaType_0":"vQtrpEvAZSPE0z62CA11EZEc13ZNPMf3wE9GVHnl7pBP", "TeaType_1":"VvtzN2Mg8H7rW4NWH9EPnKAclE03pDhYKGLNqhDK0DQj", "TeaType_2":"57tw5MA61c9PLrZEHvr1pwWU8rKL7JUmZwGQOuvNQWDw", "Type_0":"6WtZjPXyJf1q0jNqSv8pDowu13x6ZoCZ0QGAPhglLOXM"}},"params":{"anchor":"section-characteristics","canExpand":false,"columns":2,"dataType":"characteristics","disablePaidBrand":false,"disclaimer":"Информация о технических характеристиках, комплекте поставки, стране изготовления, внешнем виде и цвете товара носит справочный характер и основывается на последних доступных к моменту публикации сведениях","hintMaxLength":1500,"isShowTitleAsH1":false,"isWidgetCharacteristicsOnPage":false,"isWidgetDescriptionOnPage":false,"limit":300,"linkToCharacteristics":"#section-characteristics","linkToCharacteristicsButtonText":"Перейти к характеристикам","linkToDescription":"#section-description","linkToDescriptionButtonText":"Перейти к описанию","linkToExternal":"","linkToExternalText":"Подробнее","markedDownLink":"https://docs.ozon.ru/common-mobile/discounted-products/","paramsLinkTarget":"self","showLongCharacteristics":true,"theme":"default","thresholdLength":60,"title":"Характеристики","topList":false,"viewLine":"dotted","visibleCount":100}}', 'description': '{"characteristics":[{"title":"Условия хранения", "content":"Хранить в плотно закрытой упаковке в темном месте,ограничивая воздействие высоких температур,влажности,солнечного света и посторонних запахов"}, {"title":"Состав", "content":"Смола шу пуэра 10 штук, смола шен пуэра с османтусом 10 штук, смола шу пуэра с мандарином 10 штук, смола шен пуэра с орхидеей 10 штук, смола белого чая 10 штук."}], "lexemes":{"errorMessage":"Не удалось загрузить статью.", "externalDescriptionText":"Читать далее", "showAllText":"Показать полностью"},"params":{"anchor":"section-description","descriptionMode":"characteristics","enableClickableLinks":false,"isWidgetCharacteristicsOnPage":false,"isWidgetDescriptionOnPage":false,"linkToCharacteristics":"#section-characteristics","linkToCharacteristicsButtonText":"Перейти к характеристикам","linkToDescription":"#section-description","linkToDescriptionButtonText":"Перейти к описанию","linkToExternal":"","linkToExternalText":"Подробнее","loaderOffsetTop":63,"maxHeight":512,"shortDescriptionLimit":1000,"tabTitleRichAnnotation":"","tabTitleRichContent":"","title":""}}'}]
import pprint
# pprint.pprint(rows_plus)

pprint.pprint(reviews)
print(len(reviews))